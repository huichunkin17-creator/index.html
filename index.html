<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cathay Christmas!</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
      body { background: #005D63; font-family: Montserrat; text-align: center; padding: 20px; color: #ffffff; }
      h1 { font-family: Playfair Display; color: #ffffff; font-size: 50px; text-shadow: 2px 2px 10px #822C42; }
      p { color: #ffffff; }
      .box { border: 8px double #ffffff; padding: 30px; max-width: 750px; margin: auto; border-radius: 20px; background: rgba(0,93,99,0.95); position: relative; box-shadow: 0 0 40px #822C42; }
      video { border: 12px solid #ffffff; border-radius: 15px; box-shadow: 0 0 30px #822C42; }
      button { background: #877A5C; color: #ffffff; padding: 15px 30px; margin: 10px; font-size: 1.2em; border: 4px solid #ffffff; border-radius: 50px; cursor: pointer; }
      button:hover { background: #ffffff; color: #877A5C; }
      .filter { background:#822C42; color:white; border:3px solid #ffffff; }
      #countdown { font-size:80px; color:#ff69b4; font-weight:bold; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); display:none; z-index:10; text-shadow: 0 0 20px white; }
      #gallery img { max-width: 100%; margin: 20px auto; display: block; border: none; box-shadow: none; }
      #qrCode img { max-width: 340px; margin: 20px; border: 10px double #ffffff; border-radius: 15px; }
      #qrContainer { margin: 30px 0; background: rgba(130,44,66,0.9); padding: 25px; border-radius: 20px; border: 4px solid #ffffff; }
      #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
      .snow { position: absolute; color: white; font-size: 20px; animation: fall linear infinite; }
      @keyframes fall { to { transform: translateY(100vh); } }
      #shareOptions { margin: 20px; padding: 20px; background: rgba(255,255,255,0.2); border-radius: 20px; }
</style>
</head>
<body>
<div id="snow-container"></div>
<div class="box">
<h1>Cathay Christmas! üéÑ‚ú®</h1>
<p>Merry Christmas from across the miles!</p>
<div style="position:relative; display:inline-block;">
<video id="video" width="640" height="480" autoplay playsinline></video>
<div id="countdown">3</div>
</div>
<br>
<button id="start">Start Camera üéÑ</button>
<div style="margin:20px;">
<button class="filter" data-f="none">Normal</button>
<button class="filter" data-f="bw">B&W</button>
<button class="filter" data-f="film">Film Camera üìΩÔ∏è</button>
</div>
<button id="snap">Start 4-Photo Christmas Session üéÖ</button>
<canvas id="canvas" style="display:none;"></canvas>
<canvas id="final" style="display:none;"></canvas>
<div id="gallery"></div>
<div id="shareOptions" style="display:none;">
<p style="font-size:1.4em; color:white;">Your Cathay Christmas Photos are ready! üéüÔ∏è</p>
<button id="downloadBtn">Download Photo Strip üì•</button>
<button id="whatsappBtn">Share on WhatsApp üì±</button>
<button id="emailBtn">Email to Myself ‚úâÔ∏è</button>
<button id="copyLinkBtn">Copy Link to Clipboard üîó</button>
<div id="qrCode"></div>
</div>
</div>
<script>
      // Falling snow
      function createSnow() {
          const snow = document.createElement('div');
          snow.classList.add('snow');
          snow.textContent = ['‚ùÑ','‚ùÖ','‚ùÜ'][Math.floor(Math.random()*3)];
          snow.style.left = Math.random() * 100 + 'vw';
          snow.style.animationDuration = Math.random() * 3 + 2 + 's';
          snow.style.opacity = Math.random() * 0.8 + 0.2;
          snow.style.fontSize = Math.random() * 20 + 10 + 'px';
          document.getElementById('snow-container').appendChild(snow);
          setTimeout(() => snow.remove(), 6000);
      }
      setInterval(createSnow, 80);
      let stream;
      const video = document.getElementById('video');
      document.getElementById('start').onclick = async () => {
          try {
              stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
              video.srcObject = stream;
              video.play();
              document.getElementById('start').style.display = 'none';
          } catch (err) {
              alert("Camera error: " + err.message + ". Try Chrome on desktop or Safari on iOS.");
          }
      };
      let filter = 'none';
      document.querySelectorAll('.filter').forEach(b => b.onclick = () => filter = b.dataset.f);
      let photos = [];
      let currentStripUrl = '';
      document.getElementById('snap').onclick = () => {
          photos = [];
          document.getElementById('shareOptions').style.display = 'none';
          document.getElementById('gallery').innerHTML = '';
          shoot(1);
      };
      function shoot(n) {
          let cd = document.getElementById('countdown');
          cd.style.display = 'block'; cd.textContent = '3';
          let c = 3;
          let timer = setInterval(() => {
              c--; cd.textContent = c;
              if (c == 0) {
                  clearInterval(timer); cd.style.display = 'none';
                  snapOne(n);
              }
          }, 1000);
      }
      function snapOne(n) {
          let v = document.getElementById('video');
          let c = document.getElementById('canvas');
          c.width = v.videoWidth || 640;
          c.height = v.videoHeight || 480;
          let ctx = c.getContext('2d');
          ctx.drawImage(v, 0, 0, c.width, c.height);
          if (filter === 'bw') {
              let imgData = ctx.getImageData(0, 0, c.width, c.height);
              let data = imgData.data;
              for (let i = 0; i < data.length; i += 4) {
                  let gray = data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114;
                  data[i] = data[i+1] = data[i+2] = gray;
              }
              ctx.putImageData(imgData, 0, 0);
          } else if (filter === 'film') {
              ctx.filter = 'contrast(1.2) saturate(1.1) sepia(0.3)';
              ctx.drawImage(v, 0, 0);
              const gradient = ctx.createLinearGradient(0, 0, c.width, c.height);
              gradient.addColorStop(0, 'rgba(255,180,100,0.15)');
              gradient.addColorStop(0.5, 'rgba(255,100,100,0.1)');
              gradient.addColorStop(1, 'rgba(255,200,100,0.15)');
              ctx.fillStyle = gradient;
              ctx.fillRect(0, 0, c.width, c.height);
              // Film grain (fixed: skip alpha channel)
              let imgData = ctx.getImageData(0, 0, c.width, c.height);
              let data = imgData.data;
              for (let i = 0; i < data.length; i += 4) {
                  let grain = (Math.random() - 0.5) * 20;
                  data[i] += grain;
                  data[i+1] += grain;
                  data[i+2] += grain;
              }
              ctx.putImageData(imgData, 0, 0);
              // Vignette
              const vignette = ctx.createRadialGradient(c.width/2, c.height/2, 0, c.width/2, c.height/2, c.width/2);
              vignette.addColorStop(0, 'transparent');
              vignette.addColorStop(0.8, 'transparent');
              vignette.addColorStop(1, 'rgba(0,0,0,0.6)');
              ctx.fillStyle = vignette;
              ctx.fillRect(0, 0, c.width, c.height);
              // Film border text
              ctx.font = 'bold 24px Montserrat';
              ctx.fillStyle = '#ffffff';
              ctx.textAlign = 'left';
              ctx.fillText('KODAK 400 ‚Ä¢ ' + new Date().toLocaleDateString(), 20, c.height - 20);
              ctx.textAlign = 'right';
              ctx.fillText('CATHAY CHRISTMAS', c.width - 20, c.height - 20);
          }
          photos.push(c.toDataURL('image/png'));
          if (n < 4) setTimeout(() => shoot(n+1), 1500);
          else makeOriginalStrip();
      }
      function makeOriginalStrip() {
          let f = document.getElementById('final');
          f.width = 640;
          f.height = 480 * 4 + 150;
          let ctx = f.getContext('2d');
          ctx.fillStyle = '#ffffff';
          ctx.fillRect(0, 0, f.width, f.height);
          ctx.font = 'bold 48px Playfair Display';
          ctx.fillStyle = '#005D63';
          ctx.textAlign = 'center';
          ctx.fillText('Cathay Christmas!', 320, 70);
          ctx.font = '28px Montserrat';
          ctx.fillStyle = '#822C42';
          ctx.fillText('There is snow one like you!', 320, 120);
          let loaded = 0;
          photos.forEach((p, i) => {
              let img = new Image();
              img.src = p;
              img.onload = () => {
                  ctx.drawImage(img, 0, 150 + i * 480, 640, 480);
                  loaded++;
                  if (loaded === 4) finalizeOriginal();
              };
          });
      }
      function finalizeOriginal() {
          currentStripUrl = document.getElementById('final').toDataURL('image/png');
          let a = document.createElement('a');
          a.download = 'Cathay-Christmas-' + Date.now() + '.png';
          a.href = currentStripUrl;
          a.click();
          let preview = document.createElement('img');
          preview.src = currentStripUrl;
          preview.style.maxWidth = '100%';
          preview.onclick = () => window.open(currentStripUrl);
          document.getElementById('gallery').innerHTML = '';
          document.getElementById('gallery').appendChild(preview);
          document.getElementById('shareOptions').style.display = 'block';
          document.getElementById('downloadBtn').onclick = () => {
              let a = document.createElement('a');
              a.download = 'Cathay-Christmas.png';
              a.href = currentStripUrl;
              a.click();
          };
          document.getElementById('whatsappBtn').onclick = () => {
              const text = "Merry Christmas from across the miles! üéÑ‚ú®";
              window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + currentStripUrl)}`);
          };
          document.getElementById('emailBtn').onclick = () => {
              window.open(`mailto:?subject=Merry Christmas from across the miles!&body=Here is my Cathay Christmas photo! ${currentStripUrl}`);
          };
          document.getElementById('copyLinkBtn').onclick = () => {
              navigator.clipboard.writeText(currentStripUrl).then(() => alert('Link copied!'));
          };
          const qrDiv = document.getElementById('qrCode');
          qrDiv.innerHTML = `<p style="color:white; font-size:1.2em;">Scan to download instantly:</p><img src="https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=${encodeURIComponent(currentStripUrl)}" alt="QR Code">`;
      }
</script>
</body>
</html>